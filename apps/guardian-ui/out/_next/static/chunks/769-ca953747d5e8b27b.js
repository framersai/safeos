"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[769],{96769:function(e,t,i){i.d(t,{t:function(){return h}});var s=i(59625),a=i(89134),n=i(21542);let o=null;function r(){return o||(o=(0,n.X3)("safeos-guardian",1,{upgrade(e){if(e.objectStoreNames.contains("local_session")||e.createObjectStore("local_session",{keyPath:"id"}),e.objectStoreNames.contains("profile_cache")||e.createObjectStore("profile_cache",{keyPath:"id"}),e.objectStoreNames.contains("stream_cache")||e.createObjectStore("stream_cache",{keyPath:"id"}).createIndex("by-created","createdAt"),!e.objectStoreNames.contains("alert_cache")){let t=e.createObjectStore("alert_cache",{keyPath:"id"});t.createIndex("by-stream","streamId"),t.createIndex("by-created","createdAt")}if(!e.objectStoreNames.contains("frame_cache")){let t=e.createObjectStore("frame_cache",{keyPath:"id"});t.createIndex("by-stream","streamId"),t.createIndex("by-created","createdAt")}e.objectStoreNames.contains("sync_queue")||e.createObjectStore("sync_queue",{keyPath:"id"}).createIndex("by-created","createdAt"),e.objectStoreNames.contains("settings_cache")||e.createObjectStore("settings_cache",{keyPath:"key"}),e.objectStoreNames.contains("consent_log")||e.createObjectStore("consent_log",{keyPath:"id"}).createIndex("by-type","consentType")}})),o}async function c(e){try{let t=await r();await t.put("local_session",e)}catch(e){console.warn("[ClientDB] Failed to save session:",e)}}async function l(){try{let e=await r(),t=await e.getAll("local_session"),i=new Date().toISOString();return t.find(e=>e.expiresAt>i)||null}catch(e){return console.warn("[ClientDB] Failed to get session:",e),null}}async function d(){try{let e=await r();await e.clear("local_session")}catch(e){}}async function u(e){try{let t=await r();await t.put("profile_cache",{id:e.id,displayName:e.displayName,avatarUrl:e.avatarUrl,preferences:e.preferences||{},notificationSettings:e.notificationSettings||{},updatedAt:new Date().toISOString()})}catch(e){console.warn("[ClientDB] Failed to cache profile:",e)}}let f="http://localhost:3001";function p(){let e="undefined"!=typeof localStorage?localStorage.getItem("safeos_device_id"):null;if(e)return e;let t="device-".concat(Date.now(),"-").concat(Math.random().toString(36).slice(2,11));return"undefined"!=typeof localStorage&&localStorage.setItem("safeos_device_id",t),t}let h=(0,s.Ue)()((0,a.tJ)((e,t)=>({isInitialized:!1,isLoading:!1,isAuthenticated:!1,isLoggedIn:!1,isGuest:!0,sessionToken:null,sessionId:null,deviceId:null,profile:null,user:null,expiresAt:null,initialize:async()=>{if(!t().isInitialized){e({isLoading:!0});try{let i=p();e({deviceId:i});let s=await l();if(s&&new Date(s.expiresAt)>new Date)try{let t=await fetch("".concat(f,"/api/auth/session"),{headers:{"X-Session-Token":s.token}});if(t.ok){let{data:i}=await t.json();e({isAuthenticated:!0,isGuest:i.isGuest,sessionToken:i.token,sessionId:i.sessionId,profile:i.profile,expiresAt:i.expiresAt,isInitialized:!0,isLoading:!1});return}}catch(t){console.log("[Auth] Offline, using cached session"),e({isAuthenticated:!0,isGuest:!0,sessionToken:s.token,sessionId:s.id,profile:s.profile,expiresAt:s.expiresAt,isInitialized:!0,isLoading:!1});return}await t().createSession()}catch(t){console.error("[Auth] Initialization failed:",t),e({isInitialized:!0,isLoading:!1})}}},createSession:async i=>{e({isLoading:!0});try{let s=t().deviceId||p(),a=await fetch("".concat(f,"/api/auth/session"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deviceId:s,displayName:i})});if(!a.ok)throw Error("Failed to create session");let{data:n}=await a.json();await c({id:n.sessionId,token:n.token,deviceId:s,profile:n.profile,createdAt:new Date().toISOString(),expiresAt:n.expiresAt,syncedAt:new Date().toISOString()}),n.profile&&await u(n.profile),e({isAuthenticated:!0,isGuest:n.isGuest,sessionToken:n.token,sessionId:n.sessionId,deviceId:s,profile:n.profile,expiresAt:n.expiresAt,isInitialized:!0,isLoading:!1})}catch(a){console.error("[Auth] Failed to create session:",a);let t="guest-".concat(Date.now()),s={id:t,displayName:i||"Guest-".concat(t.slice(0,6)),avatarUrl:null,preferences:{defaultScenario:"pet",motionSensitivity:.5,audioSensitivity:.5,alertVolume:.7,theme:"dark"},notificationSettings:{browserPush:!0,sms:!1,telegram:!1,emailDigest:!1,quietHoursStart:null,quietHoursEnd:null},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};await u(s),e({isAuthenticated:!0,isGuest:!0,sessionToken:"offline-".concat(t),sessionId:t,profile:s,expiresAt:new Date(Date.now()+2592e6).toISOString(),isInitialized:!0,isLoading:!1})}},refreshSession:async()=>{let i=t().sessionToken;if(i)try{let t=await fetch("".concat(f,"/api/auth/session"),{headers:{"X-Session-Token":i}});if(t.ok){let{data:i}=await t.json();e({profile:i.profile,expiresAt:i.expiresAt})}}catch(e){console.error("[Auth] Failed to refresh session:",e)}},updateProfile:async i=>{let s=t().sessionToken,a=t().profile;if(!a)return;let n={...a,...i,updatedAt:new Date().toISOString()};e({profile:n});try{s&&!s.startsWith("offline-")&&await fetch("".concat(f,"/api/auth/profile"),{method:"PATCH",headers:{"Content-Type":"application/json","X-Session-Token":s},body:JSON.stringify(i)}),await u(n)}catch(e){console.error("[Auth] Failed to update profile:",e)}},updatePreferences:async e=>{let i=t().profile;i&&await t().updateProfile({preferences:{...i.preferences,...e}})},updateNotificationSettings:async e=>{let i=t().profile;i&&await t().updateProfile({notificationSettings:{...i.notificationSettings,...e}})},logout:async()=>{let i=t().sessionToken;try{i&&!i.startsWith("offline-")&&await fetch("".concat(f,"/api/auth/session"),{method:"DELETE",headers:{"X-Session-Token":i}})}catch(e){console.error("[Auth] Logout error:",e)}await d(),e({isAuthenticated:!1,isGuest:!0,sessionToken:null,sessionId:null,profile:null,expiresAt:null})},setDeviceId:t=>{e({deviceId:t}),"undefined"!=typeof localStorage&&localStorage.setItem("safeos_device_id",t)},login:t=>{e({isAuthenticated:!0,isLoggedIn:!0,isGuest:!1,user:t,profile:{id:t.id,displayName:t.displayName,avatarUrl:null,preferences:t.preferences,notificationSettings:{browserPush:!0,sms:!1,telegram:!1,emailDigest:!1,quietHoursStart:null,quietHoursEnd:null},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}})},startGuestSession:t=>{e({isAuthenticated:!0,isLoggedIn:!0,isGuest:!0,user:t,profile:{id:t.id,displayName:t.displayName,avatarUrl:null,preferences:t.preferences,notificationSettings:{browserPush:!0,sms:!1,telegram:!1,emailDigest:!1,quietHoursStart:null,quietHoursEnd:null},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}})}}),{name:"safeos-auth",storage:(0,a.FL)(()=>localStorage),partialize:e=>({sessionToken:e.sessionToken,sessionId:e.sessionId,deviceId:e.deviceId,isGuest:e.isGuest})}))}}]);